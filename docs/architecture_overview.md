# PaperBot System Architecture

> **Version**: 1.0
> **Last Updated**: 2026-02-06
> **Author**: Claude Code

---

## Table of Contents

1. [System Overview](#1-system-overview)
2. [Layered Architecture](#2-layered-architecture)
3. [Core Components](#3-core-components)
4. [Data Flow](#4-data-flow)
5. [External Integrations](#5-external-integrations)
6. [Design Patterns](#6-design-patterns)
7. [Configuration](#7-configuration)

---

## 1. System Overview

PaperBot is a **multi-agent research workflow framework** designed for academic paper analysis, scholar tracking, and code reproduction. It consists of three main components:

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           PaperBot System Architecture                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐               │
│  │   Web Dashboard │   │   Terminal CLI  │   │   Python API    │               │
│  │   (Next.js 16)  │   │   (Ink/React)   │   │   (Direct)      │               │
│  └────────┬────────┘   └────────┬────────┘   └────────┬────────┘               │
│           │                     │                     │                         │
│           └─────────────────────┼─────────────────────┘                         │
│                                 │                                               │
│                                 ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                     FastAPI Backend (Python)                              │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  SSE Streaming  │  REST API  │  WebSocket (future)                  │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                          │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │  │
│  │  │   Scholar    │  │    Paper     │  │  Paper2Code  │  │   Research   │  │  │
│  │  │   Tracking   │  │   Analysis   │  │   Pipeline   │  │   Context    │  │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │  │
│  │                                                                          │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │  │              Multi-Agent Orchestration System                     │   │  │
│  │  │   ResearchAgent │ CodeAgent │ QualityAgent │ InfluenceCalc │ ... │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                 │                                               │
│           ┌─────────────────────┼─────────────────────┐                         │
│           ▼                     ▼                     ▼                         │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐               │
│  │     SQLite      │   │   LLM APIs      │   │  External APIs  │               │
│  │   (Persistence) │   │ (Claude/OpenAI) │   │ (S2/GitHub/...) │               │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Directory Structure

```
src/paperbot/
├── api/                    # API Layer - FastAPI routes & streaming
├── application/            # Application Layer - Business logic, workflows
├── domain/                 # Domain Layer - Core models, entities
├── infrastructure/         # Infrastructure Layer - External services, DB
├── core/                   # Core abstractions & patterns
├── agents/                 # Multi-agent implementations
├── repro/                  # Paper2Code pipeline
├── context_engine/         # Research context routing
├── memory/                 # User memory extraction
├── presentation/           # UI components (reports, CLI)
└── workflows/              # Workflow orchestration
```

---

## 2. Layered Architecture

PaperBot follows a **Clean Architecture** approach with clear separation of concerns:

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION LAYER                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │  Web Dashboard (Next.js)  │  Terminal CLI (Ink)  │  API Clients             ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                       │                                          │
│                                       ▼                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                 API LAYER                                        │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │  FastAPI Application (api/main.py)                                          ││
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐     ││
│  │  │  /track   │ │ /analyze  │ │ /gen-code │ │ /research │ │  /memory  │     ││
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘     ││
│  │  ┌───────────────────────────────────────────────────────────────────┐     ││
│  │  │  SSE Streaming (streaming.py)  │  CORS Middleware  │  Auth        │     ││
│  │  └───────────────────────────────────────────────────────────────────┘     ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                       │                                          │
│                                       ▼                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                            APPLICATION LAYER                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │  Workflows & Pipelines                                                       ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              ││
│  │  │ ScholarPipeline │  │ Paper2Code Orch │  │ HarvestPipeline │              ││
│  │  │ (scholar_pipeline)│ │  (orchestrator) │  │    (v1 NEW)     │              ││
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘              ││
│  │                                                                              ││
│  │  Services & Ports                                                            ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              ││
│  │  │  EventLogPort   │  │ SourceRegistry  │  │ WorkflowRegistry│              ││
│  │  │   (Protocol)    │  │  (Data Sources) │  │   (Workflows)   │              ││
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘              ││
│  │                                                                              ││
│  │  Collaboration                                                               ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              ││
│  │  │AgentCoordinator │  │  ScoreShareBus  │  │ FailFastEvaluator│             ││
│  │  │ (message bus)   │  │ (cross-stage)   │  │ (early stop)    │              ││
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘              ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                       │                                          │
│                                       ▼                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              DOMAIN LAYER                                        │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │  Core Models                                                                 ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         ││
│  │  │  PaperMeta  │  │  Scholar    │  │  Influence  │  │ HarvestedPaper│        ││
│  │  │  (paper.py) │  │ (scholar.py)│  │(influence/) │  │  (v1 NEW)   │         ││
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘         ││
│  │                                                                              ││
│  │  Agents (BaseAgent → Specialized)                                            ││
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           ││
│  │  │ Research │ │  Code    │ │ Quality  │ │  Review  │ │ Influence│           ││
│  │  │  Agent   │ │ Analysis │ │  Agent   │ │  Agent   │ │Calculator│           ││
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘           ││
│  │                                                                              ││
│  │  Core Abstractions (core/)                                                   ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              ││
│  │  │   Executable    │  │ ExecutionResult │  │   DI Container  │              ││
│  │  │  (interface)    │  │  (result type)  │  │   (singleton)   │              ││
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘              ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                       │                                          │
│                                       ▼                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                           INFRASTRUCTURE LAYER                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │  LLM Integration                                                             ││
│  │  ┌─────────────────────────────────────────────────────────────────┐        ││
│  │  │  LLMClient (llm/base.py)                                        │        ││
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │        ││
│  │  │  │ Claude  │  │ OpenAI  │  │DeepSeek │  │ Custom  │            │        ││
│  │  │  │ (Anthropic)│ │(GPT-4) │  │         │  │ Endpoint│            │        ││
│  │  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │        ││
│  │  └─────────────────────────────────────────────────────────────────┘        ││
│  │                                                                              ││
│  │  API Clients                                                                 ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         ││
│  │  │  Semantic   │  │   GitHub    │  │ OpenReview  │  │   arXiv     │         ││
│  │  │  Scholar    │  │   API       │  │    API      │  │   API       │         ││
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘         ││
│  │                                                                              ││
│  │  Persistence                                                                 ││
│  │  ┌─────────────────────────────────────────────────────────────────┐        ││
│  │  │  SQLAlchemy ORM (stores/models.py)                              │        ││
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │        ││
│  │  │  │AgentRun │ │AgentEvent│ │ Memory  │ │Research │ │ Papers  │   │        ││
│  │  │  │  Model  │ │  Model  │ │  Model  │ │ Track   │ │(v1 NEW) │   │        ││
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │        ││
│  │  └─────────────────────────────────────────────────────────────────┘        ││
│  │                                                                              ││
│  │  Event Logging                                                               ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                          ││
│  │  │  Logging    │  │ SQLAlchemy  │  │  Composite  │                          ││
│  │  │  EventLog   │  │  EventLog   │  │  EventLog   │                          ││
│  │  └─────────────┘  └─────────────┘  └─────────────┘                          ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                       │                                          │
│                                       ▼                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                            EXTERNAL SYSTEMS                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   ││
│  │  │ SQLite  │ │Anthropic│ │ OpenAI  │ │Semantic │ │ GitHub  │ │ Docker  │   ││
│  │  │   DB    │ │   API   │ │   API   │ │ Scholar │ │   API   │ │  / E2B  │   ││
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Layer Responsibilities

| Layer | Responsibility | Key Components |
|-------|----------------|----------------|
| **Presentation** | User interface, client applications | Web Dashboard, Terminal CLI |
| **API** | HTTP endpoints, streaming, middleware | FastAPI routes, SSE streaming |
| **Application** | Business workflows, orchestration | Pipelines, Coordinators, Services |
| **Domain** | Core business logic, entities | Models, Agents, Influence calculations |
| **Infrastructure** | External services, persistence | LLM clients, API clients, SQLAlchemy |

---

## 3. Core Components

### 3.1 Multi-Agent System

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Multi-Agent Orchestration                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        AgentCoordinator                                  │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │  - register(agent)      - Agent registration                    │    │   │
│  │  │  - broadcast(message)   - Message distribution                  │    │   │
│  │  │  - collect()            - Result aggregation                    │    │   │
│  │  │  - synthesize()         - Final synthesis                       │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────┬─────────────────────────────────────────┘   │
│                                  │                                              │
│         ┌────────────────────────┼────────────────────────┐                    │
│         │                        │                        │                    │
│         ▼                        ▼                        ▼                    │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐            │
│  │ScoreShareBus│          │FailFastEval │          │  EventLog   │            │
│  │             │          │             │          │             │            │
│  │ Cross-stage │          │ Early stop  │          │ Persistence │            │
│  │ score share │          │ on low qual │          │  & audit    │            │
│  └─────────────┘          └─────────────┘          └─────────────┘            │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         Registered Agents                                │   │
│  │                                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │   │
│  │  │ ResearchAgent│  │CodeAnalysis  │  │ QualityAgent │  │ ReviewAgent  │ │   │
│  │  │              │  │    Agent     │  │              │  │              │ │   │
│  │  │ - S2 search  │  │ - GitHub API │  │ - Quality    │  │ - Peer review│ │   │
│  │  │ - Enrichment │  │ - Code health│  │   scoring    │  │   simulation │ │   │
│  │  │ - Grounding  │  │ - Dependencies│ │ - Method eval│  │ - Strengths  │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘ │   │
│  │                                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │   │
│  │  │ Influence    │  │Verification  │  │ Documentation│                   │   │
│  │  │ Calculator   │  │   Agent      │  │    Agent     │                   │   │
│  │  │              │  │              │  │              │                   │   │
│  │  │ - Citation   │  │ - Claim check│  │ - API docs   │                   │   │
│  │  │   velocity   │  │ - Method     │  │ - Code docs  │                   │   │
│  │  │ - Momentum   │  │   validation │  │   extraction │                   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 BaseAgent Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           BaseAgent (Template Method)                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  execute(input: TInput) → ExecutionResult[TOutput]                      │   │
│  │                                                                          │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ 1. Validate     │  _validate_input(input)                            │   │
│  │  │    Input        │  - Check required fields                           │   │
│  │  └────────┬────────┘  - Validate constraints                            │   │
│  │           │                                                              │   │
│  │           ▼                                                              │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ 2. Execute      │  _execute(input) [ABSTRACT]                        │   │
│  │  │    Core Logic   │  - Implemented by subclass                         │   │
│  │  └────────┬────────┘  - LLM calls, API calls, etc.                      │   │
│  │           │                                                              │   │
│  │           ▼                                                              │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ 3. Post-Process │  _post_process(result)                             │   │
│  │  │    Results      │  - Format output                                   │   │
│  │  └─────────────────┘  - Emit events                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  ExecutionResult[TOutput]                                                │   │
│  │  {                                                                       │   │
│  │    success: bool,                                                        │   │
│  │    data: Optional[TOutput],                                              │   │
│  │    error: Optional[str],                                                 │   │
│  │    duration_ms: Optional[float],                                         │   │
│  │    metadata: Dict[str, Any]                                              │   │
│  │  }                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Mixins                                                                  │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │SemanticScholar  │  │  JSONParser     │  │  TextParsing    │          │   │
│  │  │    Mixin        │  │    Mixin        │  │    Mixin        │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Paper2Code Pipeline (ReproAgent)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Paper2Code Pipeline                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Input: Paper Context (PDF/URL → Parsed Content)                        │   │
│  └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Stage 1: Planning Agent                                                 │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │  - Blueprint distillation                                       │    │   │
│  │  │  - Implementation plan generation                               │    │   │
│  │  │  - File structure design                                        │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Stage 2: Coding Agent                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │   │
│  │  │  │ CodeMemory  │  │   CodeRAG   │  │  LLM Gen    │              │    │   │
│  │  │  │             │  │             │  │             │              │    │   │
│  │  │  │Cross-file   │  │ Pattern     │  │ Code        │              │    │   │
│  │  │  │context      │  │ retrieval   │  │ generation  │              │    │   │
│  │  │  │AST indexing │  │ similarity  │  │             │              │    │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘              │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Stage 3: Verification Agent                                             │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │  - Syntax validation                                            │    │   │
│  │  │  - Import checking                                              │    │   │
│  │  │  - Test execution (sandbox)                                     │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                      │                                          │
│                      ┌───────────────┴───────────────┐                         │
│                      │         Pass?                 │                         │
│                      └───────────────┬───────────────┘                         │
│                         No │                 │ Yes                             │
│                            ▼                 │                                  │
│  ┌─────────────────────────────────────┐    │                                  │
│  │  Stage 4: Debugging Agent           │    │                                  │
│  │  ┌─────────────────────────────┐    │    │                                  │
│  │  │  - Error analysis           │    │    │                                  │
│  │  │  - Fix generation           │    │    │                                  │
│  │  │  - Retry (max_repair_loops) │◄───┼────┘                                  │
│  │  └─────────────────────────────┘    │                                       │
│  └─────────────────────────────────────┘                                       │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Output: Generated Code + Execution Report                               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Execution Environments                                                  │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                      │   │
│  │  │   Docker    │  │    E2B      │  │   Local     │                      │   │
│  │  │  Executor   │  │  (Cloud)    │  │  (Dev only) │                      │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Memory System

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             Memory System                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Input Sources                                                           │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │   ChatGPT   │  │   Gemini    │  │   Claude    │  │  Plain Text │     │   │
│  │  │   Export    │  │   Export    │  │   Export    │  │             │     │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │   │
│  └─────────┼────────────────┼────────────────┼────────────────┼─────────────┘   │
│            └────────────────┼────────────────┼────────────────┘                 │
│                             ▼                ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Memory Extractor                                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │  - Parse conversation format                                    │    │   │
│  │  │  - Extract memory candidates                                    │    │   │
│  │  │  - Classify by type (profile, preference, goal, fact, etc.)     │    │   │
│  │  │  - Calculate confidence scores                                  │    │   │
│  │  │  - Detect PII risk                                              │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Memory Storage (memory_items table)                                     │   │
│  │                                                                          │   │
│  │  ┌───────────────────────────────────────────────────────────────┐      │   │
│  │  │  Memory Item                                                   │      │   │
│  │  │  - kind: profile | preference | goal | constraint | fact | ... │      │   │
│  │  │  - content: string                                             │      │   │
│  │  │  - confidence: 0.0 - 1.0                                       │      │   │
│  │  │  - status: pending | approved | rejected | superseded          │      │   │
│  │  │  - scope: global | track | workspace                           │      │   │
│  │  │  - pii_risk: 0 | 1 | 2                                         │      │   │
│  │  └───────────────────────────────────────────────────────────────┘      │   │
│  └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                      │                                          │
│              ┌───────────────────────┼───────────────────────┐                 │
│              │                       │                       │                 │
│              ▼                       ▼                       ▼                 │
│  ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐        │
│  │   Memory Inbox    │   │  Context Engine   │   │   Quality Metrics │        │
│  │                   │   │                   │   │                   │        │
│  │  - Pending review │   │  - Memory inject  │   │  - Precision ≥85% │        │
│  │  - Approve/Reject │   │  - Routing signal │   │  - FP rate ≤5%    │        │
│  │  - Scope mgmt     │   │  - Recommendation │   │  - Hit rate ≥80%  │        │
│  └───────────────────┘   └───────────────────┘   └───────────────────┘        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.5 Influence Calculation System

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Influence Calculation System                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Input: Paper Metadata + External Data                                   │   │
│  └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                      │                                          │
│         ┌────────────────────────────┼────────────────────────────┐            │
│         │                            │                            │            │
│         ▼                            ▼                            ▼            │
│  ┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐ │
│  │ Academic Metrics│          │Engineering Metrics│         │ Context Analysis│ │
│  │                 │          │                 │          │                 │ │
│  │ - Citation count│          │ - GitHub stars  │          │ - Citation      │ │
│  │ - H-index       │          │ - Forks         │          │   sentiment     │ │
│  │ - Venue tier    │          │ - Code health   │          │ - Dynamic PIS   │ │
│  │   weighting     │          │ - Doc coverage  │          │ - Momentum      │ │
│  └────────┬────────┘          └────────┬────────┘          └────────┬────────┘ │
│           │                            │                            │          │
│           └────────────────────────────┼────────────────────────────┘          │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Influence Calculator                                                    │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │  Composite Score = Σ (weight_i × metric_i)                      │    │   │
│  │  │                                                                  │    │   │
│  │  │  Weights:                                                        │    │   │
│  │  │  - Academic (citations, venue): 0.4                              │    │   │
│  │  │  - Engineering (code, stars): 0.3                                │    │   │
│  │  │  - Momentum (velocity, trend): 0.3                               │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Output: Paper Influence Score (PIS) + Breakdown                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Data Flow

### 4.1 Scholar Tracking Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Scholar Tracking Data Flow                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────────┐                                                                 │
│  │   Client   │  GET /api/track?scholar_id=xxx                                  │
│  └─────┬──────┘                                                                 │
│        │                                                                        │
│        ▼                                                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  API Route (/track)                                                    │    │
│  │  - Parse request                                                       │    │
│  │  - Create StreamingResponse                                            │    │
│  └─────────────────────────────────────┬──────────────────────────────────┘    │
│                                        │                                        │
│                                        ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  ScholarPipeline.analyze_paper()                                       │    │
│  └─────────────────────────────────────┬──────────────────────────────────┘    │
│                                        │                                        │
│                                        ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  ScholarWorkflowCoordinator                                            │    │
│  │                                                                        │    │
│  │  Stage 1: ResearchAgent                                                │    │
│  │  ┌─────────────────────────────────────────────────────────────┐      │    │
│  │  │  → Semantic Scholar API (paper search, metadata)            │      │    │
│  │  │  → Paper enrichment                                         │      │    │
│  │  │  → Emit: StreamEvent(progress)                              │      │    │
│  │  │  → ScoreShareBus.publish(research_score)                    │      │    │
│  │  └─────────────────────────────────────────────────────────────┘      │    │
│  │                          │                                            │    │
│  │                          ▼                                            │    │
│  │  Stage 2: CodeAnalysisAgent                                           │    │
│  │  ┌─────────────────────────────────────────────────────────────┐      │    │
│  │  │  → GitHub API (repo discovery)                              │      │    │
│  │  │  → Code health analysis                                     │      │    │
│  │  │  → Emit: StreamEvent(progress)                              │      │    │
│  │  │  → ScoreShareBus.publish(code_score)                        │      │    │
│  │  └─────────────────────────────────────────────────────────────┘      │    │
│  │                          │                                            │    │
│  │                          ▼                                            │    │
│  │  Stage 3: QualityAgent → InfluenceCalculator → ReportWriter           │    │
│  │  ┌─────────────────────────────────────────────────────────────┐      │    │
│  │  │  → Quality scoring                                          │      │    │
│  │  │  → Influence calculation                                    │      │    │
│  │  │  → Markdown report (Jinja2)                                 │      │    │
│  │  │  → Emit: StreamEvent(result)                                │      │    │
│  │  └─────────────────────────────────────────────────────────────┘      │    │
│  └─────────────────────────────────────┬──────────────────────────────────┘    │
│                                        │                                        │
│                                        ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  SSE Stream                                                            │    │
│  │  ┌─────────────────────────────────────────────────────────────┐      │    │
│  │  │  event: progress                                            │      │    │
│  │  │  data: {"stage": "research", "message": "Analyzing..."}     │      │    │
│  │  │                                                              │      │    │
│  │  │  event: progress                                            │      │    │
│  │  │  data: {"stage": "code", "message": "Checking GitHub..."}   │      │    │
│  │  │                                                              │      │    │
│  │  │  event: result                                              │      │    │
│  │  │  data: {"report": "...", "scores": {...}}                   │      │    │
│  │  │                                                              │      │    │
│  │  │  event: done                                                │      │    │
│  │  └─────────────────────────────────────────────────────────────┘      │    │
│  └─────────────────────────────────────┬──────────────────────────────────┘    │
│                                        │                                        │
│                                        ▼                                        │
│  ┌────────────┐                                                                 │
│  │   Client   │  Receives SSE events, updates UI                                │
│  └────────────┘                                                                 │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Research Context Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Research Context Data Flow                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  User Query: "Find papers on LLM security"                             │    │
│  └─────────────────────────────────────┬──────────────────────────────────┘    │
│                                        │                                        │
│                                        ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  Context Engine                                                        │    │
│  │                                                                        │    │
│  │  1. Load User Memory (approved items for active track)                 │    │
│  │     ┌─────────────────────────────────────────────────────────┐       │    │
│  │     │  Memory: "I'm researching adversarial ML"               │       │    │
│  │     │  Memory: "Prefer transformer-based methods"             │       │    │
│  │     │  Memory: "Deadline: March 15"                           │       │    │
│  │     └─────────────────────────────────────────────────────────┘       │    │
│  │                          │                                            │    │
│  │                          ▼                                            │    │
│  │  2. Merge Query with Memory Context                                   │    │
│  │     ┌─────────────────────────────────────────────────────────┐       │    │
│  │     │  Merged: "LLM security + adversarial ML + transformers" │       │    │
│  │     └─────────────────────────────────────────────────────────┘       │    │
│  │                          │                                            │    │
│  │                          ▼                                            │    │
│  │  3. Route to Paper Sources                                            │    │
│  │     ┌─────────────────────────────────────────────────────────┐       │    │
│  │     │  → Semantic Scholar API                                 │       │    │
│  │     │  → Local Paper Pool (v1)                                │       │    │
│  │     └─────────────────────────────────────────────────────────┘       │    │
│  │                          │                                            │    │
│  │                          ▼                                            │    │
│  │  4. Rank & Filter Results                                             │    │
│  │     ┌─────────────────────────────────────────────────────────┐       │    │
│  │     │  - Relevance scoring                                    │       │    │
│  │     │  - Memory-influenced ranking                            │       │    │
│  │     │  - Diversity balancing                                  │       │    │
│  │     └─────────────────────────────────────────────────────────┘       │    │
│  └─────────────────────────────────────┬──────────────────────────────────┘    │
│                                        │                                        │
│                                        ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  Recommendations Tab                                                   │    │
│  │  ┌─────────────────────────────────────────────────────────────┐      │    │
│  │  │  Paper 1: "Adversarial Attacks on LLMs..."   [Like] [Save]  │      │    │
│  │  │  Paper 2: "Transformer Security..."          [Like] [Save]  │      │    │
│  │  │  Paper 3: "..."                              [Like] [Save]  │      │    │
│  │  └─────────────────────────────────────────────────────────────┘      │    │
│  └────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. External Integrations

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           External Integrations                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  LLM Providers                                                           │   │
│  │                                                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │   Anthropic     │  │    OpenAI       │  │   DeepSeek      │          │   │
│  │  │   Claude API    │  │    GPT-4 API    │  │   API           │          │   │
│  │  │                 │  │                 │  │                 │          │   │
│  │  │  Primary for    │  │  Alternative    │  │  Cost-effective │          │   │
│  │  │  agent reasoning│  │  provider       │  │  option         │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  │                                                                          │   │
│  │  Unified via: LLMClient (llm/base.py)                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Academic Data Sources                                                   │   │
│  │                                                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │ Semantic Scholar│  │     arXiv       │  │   OpenAlex      │          │   │
│  │  │                 │  │                 │  │   (v1 NEW)      │          │   │
│  │  │ - Paper search  │  │ - Preprint      │  │ - 240M+ works   │          │   │
│  │  │ - Citations     │  │   metadata      │  │ - Open access   │          │   │
│  │  │ - Author data   │  │ - PDF links     │  │ - CS coverage   │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  │                                                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                               │   │
│  │  │   OpenReview    │  │  Conference     │                               │   │
│  │  │                 │  │  Websites       │                               │   │
│  │  │ - Submissions   │  │ - S&P, CCS      │                               │   │
│  │  │ - Reviews       │  │ - USENIX, NDSS  │                               │   │
│  │  └─────────────────┘  └─────────────────┘                               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Code & Repository Services                                              │   │
│  │                                                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │    GitHub       │  │   HuggingFace   │  │ Code Execution  │          │   │
│  │  │    API          │  │                 │  │                 │          │   │
│  │  │                 │  │ - Model cards   │  │ - Docker        │          │   │
│  │  │ - Repo metadata │  │ - Checkpoints   │  │ - E2B (cloud)   │          │   │
│  │  │ - Stars, forks  │  │                 │  │ - Local (dev)   │          │   │
│  │  │ - Code analysis │  │                 │  │                 │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Persistence                                                             │   │
│  │                                                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │  SQLite (Default) / PostgreSQL (Production)                     │    │   │
│  │  │                                                                  │    │   │
│  │  │  Tables:                                                         │    │   │
│  │  │  - agent_runs, agent_events (execution tracking)                 │    │   │
│  │  │  - memory_items, memory_sources (user memory)                    │    │   │
│  │  │  - research_tracks, paper_feedback (research context)            │    │   │
│  │  │  - papers, harvest_runs (v1 NEW - paper pool)                    │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Design Patterns

### Patterns Used in PaperBot

| Pattern | Location | Purpose |
|---------|----------|---------|
| **Template Method** | `agents/base.py` | Common agent execution flow with customizable steps |
| **Repository** | `application/ports/` | Abstract data access (EventLogPort) |
| **Adapter** | `infrastructure/llm/` | Unified interface for multiple LLM providers |
| **Pub/Sub** | `core/collaboration/` | AgentCoordinator message broadcasting |
| **Dependency Injection** | `core/di/container.py` | Loose coupling between components |
| **Pipeline** | `core/pipeline/` | Multi-stage processing |
| **Composite** | `infrastructure/event_log/` | Multiple event log backends |
| **Strategy** | `repro/` | Docker/E2B/Local execution strategies |
| **Factory** | `application/services/` | Object creation abstraction |

### Dependency Direction

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Dependency Direction                                     │
│                                                                                 │
│  ┌─────────────────┐                                                           │
│  │  Presentation   │  ─────────────────┐                                       │
│  │     (API)       │                   │                                       │
│  └─────────────────┘                   │                                       │
│          │                             │                                       │
│          ▼                             │                                       │
│  ┌─────────────────┐                   │    Dependencies point INWARD          │
│  │  Application    │  ─────────────────┤    toward the Domain layer            │
│  │   (Workflows)   │                   │                                       │
│  └─────────────────┘                   │                                       │
│          │                             │                                       │
│          ▼                             │                                       │
│  ┌─────────────────┐                   │                                       │
│  │    Domain       │  ◄────────────────┘                                       │
│  │   (Models)      │                                                           │
│  └─────────────────┘                                                           │
│          ▲                                                                     │
│          │                                                                     │
│  ┌─────────────────┐                                                           │
│  │ Infrastructure  │  ─────────────────────────────────────────────────────────│
│  │   (External)    │  Implements interfaces defined in Domain/Application      │
│  └─────────────────┘                                                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Configuration

### Environment Variables

```bash
# LLM API Keys
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...

# External Services
SEMANTIC_SCHOLAR_API_KEY=...  # Optional, higher rate limits
GITHUB_TOKEN=ghp_...          # Optional, higher rate limits
E2B_API_KEY=...               # Optional, cloud sandbox

# Database
PAPERBOT_DB_URL=sqlite:///data/paperbot.db

# Execution Mode
PAPERBOT_EXECUTOR=auto|docker|e2b|local
```

### Configuration Files

| File | Purpose |
|------|---------|
| `config/config.yaml` | Main application config (models, venues, thresholds) |
| `config/settings.py` | Pydantic settings validation |
| `config/scholar_subscriptions.yaml` | Tracked scholars list |
| `config/top_venues.yaml` | Venue tier rankings |

### Key Configuration Options

```yaml
# config/config.yaml (example structure)
download:
  max_retries: 3
  concurrency: 5
  timeout: 30

analysis:
  parallel: true
  max_depth: 3

security:
  ssl_verify: true
  rate_limit: 100
  domain_allowlist: [...]

output:
  formats: [markdown, html, pdf]
  template_dir: templates/

cache:
  enabled: true
  ttl: 3600

logging:
  level: INFO
  format: json
```

---

## Appendix: File Reference

### Key Implementation Files

| Component | File Path |
|-----------|-----------|
| API Entry Point | `src/paperbot/api/main.py` |
| SSE Streaming | `src/paperbot/api/streaming.py` |
| Base Agent | `src/paperbot/agents/base.py` |
| Agent Coordinator | `src/paperbot/core/collaboration/coordinator.py` |
| LLM Client | `src/paperbot/infrastructure/llm/base.py` |
| Paper Model | `src/paperbot/domain/paper.py` |
| DB Models | `src/paperbot/infrastructure/stores/models.py` |
| Event Log | `src/paperbot/infrastructure/event_log/` |
| Paper2Code | `src/paperbot/repro/orchestrator.py` |
| Memory System | `src/paperbot/memory/` |
| Context Engine | `src/paperbot/context_engine/` |

---

*Document generated by Claude Code for PaperBot project.*
